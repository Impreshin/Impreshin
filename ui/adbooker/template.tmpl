
<!doctype html>
<!--[if lt IE 7]>
<html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>
<html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>
<html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>{{ page['meta']['title']|default("") }}</title>
	<meta name="description" content="">
	<meta name="author" content="">


	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" type="text/css" href="/min/css.{{_v}}.css"/>


	<script src="/ui/_js/libs/modernizr.{{_v}}.js"></script>


	{% if page['template_css'] %}
	<link rel="stylesheet" href="{{ page['template_css'] }}">
	{% endif %}


	<link rel="shortcut icon" type="image/x-icon" href="/ui/_images/favicon.ico">
	<link rel="apple-touch-icon" href="/ui/_images/apple-touch.png">


</head>
<body>
{% include "_nav_top.tmpl" %}
{% if page['template'] %} {% include page['template'] %} {% endif %}


<footer id="pagefooter">
	<div class="container">
		<div style="position: absolute; left:10px;">
			<a href="#systemTimers-container" data-toggle="modal" ><i class="icon-time icon-d-grey"></i></a>
		</div>
		<div class="clearfix">
			<div class="row">
				<div class="span1">a</div>
				<div class="span1">b</div>
				<div class="span1">c</div>
				<div class="s" style="float: right;">
					<a href="javascript:" style="padding-right: 30px; color: #999;"><i class="icon-user icon-d-grey" style="margin-right: 10px;"></i>{{ _user['fullName']}}</a>
				</div>
			</div>
		</div>
	</div>

</footer>

<div id='systemTimers-container' class='modal hide fade'>
	<div class='modal-header'><a href='#' class='close' data-dismiss="modal">&times;</a>

		<h3>Debug</h3></div>
	<div class='modal-body'>
		<article>
			<table id='systemTimers'>

			</table>
		</article>
	</div>
	<div class='modal-footer'>

	</div>
</div>



<script src="/ui/_js/libs/jquery.{{_v}}.js"></script>


<script src="/min/js.{{_v}}.js"></script>
<script src="/ui/_js/plugins/bootstrap-typehead-array.{{_v}}.js"></script>



<script type="text/javascript">
	var detailsRequest = [];
	var listRequest = [];
	var activityRequest = [];
	var transSpeed = '{{ transSpeed |default('400') }}';
	$(function () {
		$("[rel=tooltip]").tooltip({
			live:true
		});

		$("[rel=popover]").popover({
			offset:5,
			live:true
		});

		$(document).ajaxError(function (e, xhr, settings, exception) {
			if (xhr.responseText) alert('error in: ' + settings.url + ' \n \n \n' + '\n' + xhr.responseText);
		});

		$(document).on("show", '#loggedinusers', function () {
			var $this = $(this);
			$this.find("#loggedinusers-activity table tbody").html('<tr><td colspan="2">Loading...</td></tr>');
			$.getJSON("/data/user_activity","", function (d) {
				d = d['data'];
				$area = $this.find("#loggedinusers-activity table tbody");
				if (!d[0]){
					$area.html('<tr><td colspan="2">No Users logged in for this company</td></tr>');
				} else {
					$area.jqotesub($("#template-logged-in-users"), d);
				}



			});
		});

	});
	$(document).ready(function () {

		$(document).on("click", ".modal .close-btn", function (e) {
			e.preventDefault();
			var $this = $(this), $modal = $this.closest(".modal");
			$modal.modal("hide");
		//	$("#settings-modal").modal('hide');
		});
		$(document).on("click", "*[data-dismiss='popup']", function (e) {
			e.preventDefault();
			var $this = $(this), $popup = $this.closest(".popup");
			$popup.fadeOut(transSpeed);
		});
		$(document).on("click", "*[data-target='popup']", function (e) {
			e.preventDefault();
			var $this = $(this), $popup = $this.attr("href");
			$($popup).fadeIn(transSpeed);
		});


		$(document).on("show", ".modal", function () {
			var $this = $(this);
			var h = $(window).height();
			var th = $(this).height();

			mt = (th) / 2;
			if (h < th) {
				$this.css({
					"margin-top":-(h / 2)
				});

			} else {
				$this.css("margin-top", -mt);
			}

		});



		$(document).on("click", "#keepalivebtn", function () {
			$("#displaylogout").autoLogout('resetTimer');
			$.getJSON("/data/keepalive", function (d) {
				$("#displaylogout").fadeOut(1000);
			})
		});
		$(document).on("click", "#keepalivebtn-logout", function () {
			$("#displaylogout").autoLogout('logout');

		});

	});
	$("#displaylogout").autoLogout({
		LogoutTime          :900,
		logout              :function (e) {
			window.location = "/logout?msg=You+were+logged+out+due+to+inactivity";
		},
		ShowLogoutCountdown :60,
		onLogoutCountdown   :function () {
			$("#displaylogout").fadeIn(1000);
		},
		keepAliveSelector   :".keepalive:visible",
		keepAlive           :function () {

			$.getJSON("/data/keepalive");
		},
		onResetTimer        :function (e) {
			$("#notice-area-idle").stop(true,true).fadeOut(1000)

		},
		onTimerSecond : function(timer){
			var logouttime = this.data("settings").LogoutTime, idle = logouttime - timer;
				idle = (idle<0)?0:idle;

			if (idle>360){
				var c = idle, minVar = Math.floor(c / 60), secVar = c % 60;
				var s = c - (minVar * 60);

				var str = 'You have been inactive for '+ minVar+' minutes and '+s+' seconds';
				$("#notice-area-idle").stop(true, true).fadeIn(1000).html(str);
			}
		},
		countingDownSelector:".timer",
		countingDownLook    :'you will be loged out in {s} seconds',
		countingDownLookShow:"you will be loged out in {s} seconds"
	});

	var uID = "{{ _user['ID'] }}";
	var jScrollPaneOptions = {
		showArrows:false,
		maintainPosition: false
	};
	var jScrollPaneOptionsMP = {
		showArrows:false,
		maintainPosition: true
	};

	$(document).ajaxComplete(function (event, request, settings) {
		var u = settings.url;
		var d = $.parseJSON(request.responseText);

		if (u == "/data/keepalive") {
		} else {
			updatetimerlist(d);
		}

	});
	function updatetimerlist(d) {
		//console.log(d);
		$("#displaylogout").autoLogout('resetTimer');

		var data = d['timer'];
		var page = d['page'];


		if (data) {
			var th = '<tr class="heading"><td >' + page['page'] + '</td><td class="s g">' + page['time'] + '</td></tr>';
			$("#systemTimers").prepend(th + $("#template-timers-tr").jqote(data, "*"));
		}



	}

</script>
{% if page['template_js'] %}
<script src='{{ page['template_js'] }}'></script>
{% endif %}
<script type="text/x-jqote-template" id="template-timers-tr">
	<![CDATA[

	<tr>
		<td><*= this.msg *>
			<div class="s g"><*= this.arg *></div>
		</td>
		<td><*= this.tim *></td>
	</tr>

	]]>
</script>
<script type="text/x-jqote-template" id="template-logged-in-users">
	<![CDATA[

	<tr>
		<td>
			<%= this.n %>
		</td>
		<td class="g ">
			<%= this.la %>
		</td>

	</tr>

	]]>
</script>
{% if page['template_tmpl'] %}
{% include page['template_tmpl'] %}
{% endif %}


</body>
</html>
