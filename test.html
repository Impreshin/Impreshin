<!doctype html>
<!--[if lt IE 7]>
<html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>
<html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>
<html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Test page</title>
	<meta name="description" content="">
	<meta name="author" content="">


	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" type="text/css" href="/ui/_css/libs/custom-theme/jquery-ui.css"/>
	<link rel="stylesheet" type="text/css" href="/ui/_css/style.0002044068.css"/>

</head>
<body>

<div style="padding:30px;">
	<div id="page-container">
		<div id="page-area" class="connected">
			<div data-colour="orange" data-cm="1" data-col="1" data-offset-col="1" data-offset-cm="20" data-id="1">Orange (1x1)</div>
			<div data-colour="green" data-cm="5" data-col="1" data-offset-col="1" data-offset-cm="20" data-id="2">Green (1x5)</div>

		</div>
		<div id="grid-area"></div>
	</div>



</div>

<div id="list2" class="list connected">
	<div data-colour="blue" data-cm="10" data-col="8" data-id="3">Blue (8x10)</div>
	<div data-colour="aqua" data-cm="19" data-col="2" data-id="4">Aqua (2x19)</div>
	<div data-colour="yellow" data-cm="5" data-col="2" data-id="5">Yellow (2x5)</div>
	<div data-colour="purple" data-cm="5" data-col="2" data-id="6">Purple (2x5)</div>
	<div data-colour="pink" data-cm="9" data-col="4" data-id="7">Pink (4x9)</div>
	<div data-colour="maroon" data-cm="5" data-col="3" data-id="8">Maroon (3x5)</div>
	<div data-colour="grey" data-cm="39" data-col="8" data-id="9">Grey (8x39)</div>

</div>
<div id="log"></div>
<hr/>
<div class="clearfix"></div>






<script src="/ui/_js/libs/jquery.0002044068.js"></script>
<script src="/min/js.0002044068.js"></script>

<style type="text/css">


	#page-container {
		position: relative;
		border: 1px solid #000;

		border-collapse: collapse;
		height: 400px;
		width: 200px;
		background-color: #e1e1e1;
	}

	#page-area {
		position: relative;

		z-index: 5;

	}

	#grid-area {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		z-index: 1;

	}

	.list {
		width: 200px;
		position: absolute;
		left: 350px;
		top: 30px;
		background-color: #e1e1e1;
		z-index: 0;
	}

	.list div {
		padding: 5px;
		border: 1px solid #ccc;
		margin: 3px;
	}

	#log {
		border: 1px solid #ccc;
		width: 400px;
		position: absolute;
		left: 580px;
		top: 30px;
	}

	#log .save {
		background-color: #2c2c2c;
		color: #fff;
	}

	#log .reload {
		background-color: #ccc;
		color: #444;
	}

	#page-area div {
		border: 1px solid #002a80;

	}

	#grid .row {
		margin: 0;
	}

	#grid .row .cell {
		border-bottom: 1px solid #ccc;
		border-right: 1px solid #ccc;
		display: table-cell;
		line-height: normal;
	}

	#page-area div.error {
		background-color: red;
		border-color: red;
		box-shadow: 0 0 10px red;
	}

</style>

<script type="text/javascript">

var columnsav = 8;
var cmav = 39;
var pagewidth = 262;


var page_width = 280;
var page_height = (((page_width / ( pagewidth / 100 )) * cmav) / 10);

var r_h = page_height / cmav;
r_h = Math.round(r_h);

var r_w = pagewidth / columnsav;
r_w = Math.round(r_w);

page_height = r_h * cmav;
page_width = r_w * columnsav;


$("#page-area").css({"height": page_height, "width": page_width});
$("#page-container").css({"height": page_height, "width": page_width});



function drawGrid(width, height) {
	var grid = '<div id="grid">', cell_html = '', i = 0, j = 0;

	for (; i < width; i++) {
		cell_html += '<div class="cell"></div>';
	}

	for (; j < height; j++) {
		grid += '<div class="row">' + cell_html + '</div>';
	}

	grid += '</div>';

	return grid;
}

$("#grid-area").html(drawGrid(columnsav, cmav)).find(".cell").css({"width": r_w - 1, "height": r_h - 1})


$(function () {
	var parentPos = null;
	drag();
	doLayout();




	$(".list, #page-area").sortable({
		connectWith: ".connected",
		appendTo: 'body',
		stack: "#page-area div",
		revert: 0,
		tolerance: 'pointer',
		helper: function (e) {
			var $target = $(e.target).closest("div");
			var cm = $target.attr("data-cm");
			var col = $target.attr("data-col");
			var colour = $target.attr("data-colour");

			//var width = colSize * col, 
			//var height = cmSize * cm, 

			var height = cm * r_h;
			var width = col * r_w;

			var offsetX = width / 2;
			var offsetY = height / 2;

			var str = "";
			str += '<div class="dragablethingy" style="width: ' + width + 'px; height: ' + height + 'px; margin-left: -' + offsetX + 'px; margin-top: -' + offsetY + 'px; background-color: ' + colour + '; position:relative;">';

			str += '</div>';

			return str;
		},
		update: function () {

			drag();
			doLayout();
		},
		start: function (e, ui) {
			//$("#page-area > div").css('z-index', '1');
			doLayout();
			//console.log(ui)
		},
		stop: function (event, ui) {
			//$(ui.helper).clone(true).removeClass('box ui-draggable ui-draggable-dragging').addClass('box-clone').appendTo('body');
			//$(this).sortable('cancel');

			var $this = $(ui.item);
			var cm = $this.attr("data-cm") * r_h;
			var col = $this.attr("data-col") * r_w;
			var colour = $this.attr("data-colour");

			$this.css({"height": cm - 2, "width": col - 2, "background-color": colour}).text("");

			var pos = ui.position;



			var width = col - 2;
			var height = cm - 2;

			//console.info("r_h:"+r_h+" | r_w:"+r_w)
			//console.info("h:"+cm+" | w:"+col)
			//console.log(pos);


			var oT = 0, oL = 0;

			var containerPos = $("#page-area").offset();

			//console.log(containerPos);






			oT = ((pos.top - containerPos.top) - (height / 2)) / r_h;
			oL = ((pos.left - containerPos.left) - (width / 2)) / r_w;

			oT = Math.round(oT)
			oL = Math.round(oL)


			$this.attr("data-offset-col", oL).attr("data-offset-cm", oT);
			writeChanges($this)

			//console.log("top: " + oT);
			//console.log("left: "+ oL);

			doLayout();
		},
		change: function () {

			doLayout();
		},


		cursorAt: {left: 0, top: 0}
	}).disableSelection();

	function drag() {
		$("#page-area > div").draggable({
			grid: [r_w, r_h], //containment: "#page-area,.list ", //refreshPositions: true,
			stack: "div",

			stop: function (event, ui) {
				var pos = ui.position;
				var col = pos.left / r_w;
				var cm = pos.top / r_h;

				$(ui.helper).attr("data-offset-col", col).attr("data-offset-cm", cm);
				writeChanges($(ui.helper))
				doLayout();
			}


		});
	}


	function doLayout() {
		$("#page-area div.error").removeClass("error");

		var base_zIndex = (columnsav * cmav) + 10
		$("#page-area > div").each(function () {
			var $this = $(this);

			var size = $this.attr("data-col") * $this.attr("data-cm");
			var zIndex = base_zIndex - size;
			//console.log(size)


			var offset_t = $this.attr("data-offset-cm") * r_h;
			var offset_l = $this.attr("data-offset-col") * r_w;

			var cm = $this.attr("data-cm");
			var col = $this.attr("data-col");
			var colour = $this.attr("data-colour");


			var height = cm * r_h;
			var width = col * r_w;




			if (($this.attr("data-offset-cm") * 1) + (cm * 1) > cmav) $this.addClass("error")
			if (($this.attr("data-offset-col") * 1) + (col * 1) > columnsav) $this.addClass("error")





			$this.css({
				top: offset_t,
				left: offset_l,
				position: "absolute",
				"width": width - 2,
				"height": height - 2,
				"background-color": colour,
				"z-index": zIndex
			}).text("");
			//console.log(offset_t+" | "+offset_l);
		});

		var overlaps = $('#page-area > div').overlaps();

		$.each(overlaps, function () {
			$(this).addClass("error");
		});



	}

	function writeChanges(element) {

		var offpage = false;
		var save = true;
		var cm = element.attr("data-cm");
		var col = element.attr("data-col");

		if ((element.attr("data-offset-cm") * 1) > cmav) {
			offpage = true
			save = false;
		}
		if ((element.attr("data-offset-col") * 1) > columnsav) {
			offpage = true
			save = false;
		}

		if ((element.attr("data-offset-cm") * 1 + (cm * 1)) > cmav) {
			save = false;
		}
		if ((element.attr("data-offset-col") * 1 + (col * 1)) > columnsav) {
			save = false;
		}

		var d = {
			"ID": element.attr("data-id"),
			"x_offset": offpage ? null : element.attr("data-offset-col"),
			"y_offset": offpage ? null : element.attr("data-offset-cm"),
			"offpage": offpage
		}
		console.log(d);

		var _class = "";
		var tex = "";
		if (save) {
			_class=  "save";
			tex = "Save item | ";
		}
		if (offpage) {
			_class = "reload";
			tex = "Save item and reload | "
		}

		var str = "<div class='" + _class + "'>" + tex + element.attr("data-colour");
		
			str += " - col: " + d['x_offset'] + " | cm: " + d['y_offset'];
		

		str += "</div>";

		$("#log").prepend(str)
	}


});

</script>

</body>
</html>